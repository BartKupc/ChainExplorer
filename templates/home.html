{% extends "base.html" %}

{% block title %}{{ CHAINS[current_chain].key }} - Latest Blocks{% endblock %}

{% block content %}
    <div class="container">
        <div class="header">
            <h1>Latest Blocks</h1>
            <p>Latest blocks on {{ CHAINS[current_chain].key }}</p>
        </div>

        <!-- Stats Overview -->
        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">From</div>
                <div class="stat-number">
                    {% if blocks and blocks|length > 0 %}
                        {{ blocks[-1].number }}
                    {% else %}
                        N/A
                    {% endif %}
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-label">To</div>
                <div class="stat-number">
                    {% if blocks and blocks|length > 0 %}
                        {{ blocks[0].number }}
                    {% else %}
                        N/A
                    {% endif %}
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Chain ID</div>
                <div class="stat-number">{{ CHAINS[current_chain].chain_id }}</div>

            </div>
        </div>
        {% if error %}
            <div class="error-box">
                <div class="error-header">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <h3>Connection Error</h3>
                </div>
                <div class="error-content">
                    <p class="error-message">{{ error }}</p>
                    <div class="chain-suggestions">
                        <p class="suggestion-title">Switch to a working chain:</p>
                        <div class="chain-links">
                            {% for key, chain in CHAINS.items() %}
                                {% if key != current_chain %}
                                    <a href="?chain={{ key }}" class="chain-link">
                                        <span class="chain-name">{{ key }}</span>
                                        <span class="chain-id">ID: {{ chain.chain_id }}</span>
                                    </a>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <!-- Loading Widget -->
        <div id="loading-widget" class="loading-widget">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading blocks and classifications...</div>
            <div class="loading-subtext">Analyzing transactions and contract interactions</div>
        </div>

        <!-- Content Container -->
        <div id="content-container" class="box">
            <h2>Latest Blocks</h2>
            {% if blocks %}
                <div class="controls-row">
                    <div class="older-link">
                        <a href="{{ url_for('home', chain=current_chain, n=n, start_block=blocks[-1].number) }}" class="nav-link-with-loading">
                            ‚Üê Load Older Blocks
                        </a>
                    </div>
                    <div class="home-link">
                        <a href="{{ url_for('home', chain=current_chain, n=n) }}" class="nav-link-with-loading">
                            Latest Blocks
                        </a>
                    </div>
                    <div class="newer-link">
                        <a href="{{ url_for('home', chain=current_chain, n=n, start_block=blocks[0].number - n) }}" class="nav-link-with-loading">
                            Load Newer Blocks ‚Üí
                        </a>
                    </div>
                    <div class="home-search-form">
                        <form action="{{ url_for('home', chain=current_chain) }}" method="get">
                            <input type="hidden" name="chain" value="{{ current_chain }}">
                            <input type="hidden" name="n" value="{{ n }}">
                            <input name="start_block" placeholder="Block #" class="home-search-input" required>
                            <button type="submit" class="home-search-button">Start from</button>
                        </form>
                    </div>
                </div>
                {% for b in blocks %}
                    <div class="block-item">
                        <div class="block-header">
                            <a href="{{ url_for('block_page', ref=b.number, chain=current_chain) }}" class="block-link">
                                Block #{{ b.number }}
                            </a>
                            {% if b.classification %}
                                <span class="block-type-badge {{ b.classification.block_type.lower().replace(' ', '-') }}">
                                    {{ b.classification.block_type }}
                                </span>
                            {% endif %}
                        </div>
                        
                        <div class="block-meta">
                            <span class="tx-count">{{ b.transactions|length if b.transactions is iterable else b.transactions }} transactions</span>
                            <span class="timestamp"> ¬∑ {{ b.timestamp }}</span>
                        </div>
                        
                        {% if b.classification %}
                            <div class="block-classification">
                                <div class="classification-summary">
                                    <span class="primary-activity">{{ b.classification.primary_activity }}</span>
                                    <span class="gas-efficiency">Gas: {{ b.classification.gas_efficiency }}</span>
                                </div>
                                
                                <div class="classification-breakdown">
                                    {% if b.classification.classifications.contract_creations > 0 %}
                                        <span class="badge deployment">üè≠ {{ b.classification.classifications.contract_creations }}</span>
                                    {% endif %}
                                    {% if b.classification.classifications.trex_interactions > 0 %}
                                        <span class="badge trex">ü¶ñ {{ b.classification.classifications.trex_interactions }}</span>
                                    {% endif %}
                                    {% if b.classification.classifications.erc20_transfers > 0 %}
                                        <span class="badge erc20">ü™ô {{ b.classification.classifications.erc20_transfers }}</span>
                                    {% endif %}
                                    {% if b.classification.classifications.erc721_transfers > 0 %}
                                        <span class="badge erc721">üñºÔ∏è {{ b.classification.classifications.erc721_transfers }}</span>
                                    {% endif %}
                                    {% if b.classification.classifications.generic_contracts > 0 %}
                                        <span class="badge generic">‚öôÔ∏è {{ b.classification.classifications.generic_contracts }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="info-box">
                    <p>No blocks available. {% if error %}{{ error }}{% endif %}</p>
                </div>
            {% endif %}
        </div>
    </div>

    <style>
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-box { background: white; border: 1px solid #ddd; border-radius: 6px; padding: 15px; text-align: center; flex: 1; }
        .stat-number { font-size: 2em; font-weight: bold; color: #2c3e50; }
        .stat-label { color: #666; font-size: 0.9em; margin-top: 5px; }
        
        .block-item { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 12px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .block-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        
        .block-header { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
        .block-link { color: #3498db; text-decoration: none; font-weight: bold; font-size: 1.2em; }
        .block-link:hover { color: #2980b9; }
        
        .block-type-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .deployment-block { background: #e8f5e8; color: #27ae60; border: 1px solid #a8e6a8; }
        .t-rex-activity-block { background: #fff3e0; color: #f39c12; border: 1px solid #ffcc80; }
        .token-transfer-block { background: #e3f2fd; color: #1976d2; border: 1px solid #90caf9; }
        .nft-activity-block { background: #f3e5f5; color: #7b1fa2; border: 1px solid #ce93d8; }
        .standard-block { background: #f5f5f5; color: #616161; border: 1px solid #e0e0e0; }
        
        .deployment { background: #e8f5e8; color: #27ae60; border: 1px solid #a8e6a8; }
        .trex { background: #fff3e0; color: #f39c12; border: 1px solid #ffcc80; }
        .erc20 { background: #e3f2fd; color: #1976d2; border: 1px solid #90caf9; }
        .erc721 { background: #f3e5f5; color: #7b1fa2; border: 1px solid #ce93d8; }
        .generic { background: #f5f5f5; color: #616161; border: 1px solid #e0e0e0; }
        
        .block-meta { color: #666; font-size: 0.9em; margin-bottom: 15px; }
        .tx-count { color: #e74c3c; font-weight: bold; }
        .timestamp { color: #7f8c8d; font-family: monospace; }
        
        .block-classification { border-top: 1px solid #f0f0f0; padding-top: 15px; }
        .classification-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .primary-activity { font-weight: 600; color: #2c3e50; font-size: 0.95em; }
        .gas-efficiency { font-size: 0.85em; color: #7f8c8d; background: #f8f9fa; padding: 2px 8px; border-radius: 12px; }
        
        .classification-breakdown { display: flex; gap: 8px; flex-wrap: wrap; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600; }
        .badge.deployment { background: #e8f5e8; color: #27ae60; border: 1px solid #a8e6a8; }
        .badge.trex { background: #fff3e0; color: #f39c12; border: 1px solid #ffcc80; }
        .badge.erc20 { background: #e3f2fd; color: #1976d2; border: 1px solid #90caf9; }
        .badge.erc721 { background: #f3e5f5; color: #7b1fa2; border: 1px solid #ce93d8; }
        .badge.generic { background: #f5f5f5; color: #616161; border: 1px solid #e0e0e0; }
        
        .controls-row { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .home-search-form { display: flex; gap: 10px; align-items: center; }
        .home-search-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; }
        .home-search-button { padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .home-search-button:hover { background: #2980b9; }
        
        .older-link { display: inline-block; background: #3498db; color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px; margin-top: 20px; transition: background 0.2s ease; }
        .older-link:hover { background: #2980b9; }
        
        .newer-link a { display: inline-block; background: #3498db; color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px; transition: background 0.2s ease; }
        .newer-link a:hover { background: #2980b9; }
        
        /* Loading Widget */
        .loading-widget {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .loading-subtext {
            font-size: 0.9em;
            color: #7f8c8d;
            text-align: center;
            max-width: 400px;
            line-height: 1.4;
        }
    </style>
    
    <script>
        // Show loading widget immediately when page starts loading
        const loadingWidget = document.getElementById('loading-widget');
        const contentContainer = document.getElementById('content-container');
        
        // Show loading widget immediately
        loadingWidget.style.display = 'flex';
        
        // Hide loading widget and show content when page is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Content is ready, show it immediately
            loadingWidget.style.display = 'none';
            contentContainer.style.display = 'block';
        });
    </script>
{% endblock %}
